# This file contains virtual host configuration specific to IF Archive.
# See also: ../conf-available/ifarchive.conf

SSLSessionCache  shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)
SSLSessionCacheTimeout  300

# Every virtualhost section below is repeated twice, for http (port 80)
# and https (port 443). The only difference is the SSL directives.

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName ifarchive.org
    ServerAlias www.ifarchive.org
    ServerAlias mirror.ifarchive.org
    ServerAlias origin.ifarchive.org
    ServerAlias ukrestrict.ifarchive.org
    ServerAlias bottle.ifarchive.org

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-ifarchive-access.log combined
    ErrorLog /var/ifarchive/logs/apache-ifarchive-error.log

    <Directory "/var/ifarchive/htdocs/">
       # List of IP addresses used by Cloudflare; updated Aug 2025
       # https://www.cloudflare.com/ips/ 
       Require ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
       Require ip 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
       Options +Indexes +FollowSymLinks +MultiViews
       DirectoryIndex index.html index.htm
       ReadmeName /misc/autoindex-footer.html
    </Directory>

    # Letsencrypt has to be able to check .well-known.
    <Directory "/var/ifarchive/htdocs/.well-known">
       Require all granted
    </Directory>

    # The Archive content directory (and subdirs) have custom auto-indexing.
    # Also needs Access-Control-Allow-Origin for archived files. This
    # allows sites like iplayif.com to fetch games with client-side code.
    <Directory "/var/ifarchive/htdocs/if-archive/">
        HeaderName Index
        ReadmeName /misc/autoindex-footer.html
        IndexOptions FancyIndexing HTMLTable SuppressDescription SuppressIcon IgnoreCase FoldersFirst
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    # The "Index" files are presumed to be UTF-8.
    <Files Index>
        ForceType text/plain;charset="UTF-8"
    </Files>

    # Our 451 "Unavailable For Legal Reasons" error page. The uk-block.html
    # page will redirect here.
    # This has Access-Control-Allow-Origin as well. This allows Parchment
    # (for example) to observe the error status in client-side code.
    ErrorDocument 451 /misc/451-error.html
    <Location /misc/451-error.html>
        Header set Link "<https://ifarchive.org>; rel=\"blocked-by\""
        Header set Access-Control-Allow-Origin "*"
    </Location>

    # The upload CGI script must be redirected to upload.ifarchive.org.
    RewriteEngine On
    RewriteRule ^/cgi-bin/(.*)$ https://upload.ifarchive.org/cgi-bin/$1 [R]
    
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004
    
    # Redirect the old X-ified index pages to the current ones.
    # (We have to do this one layer at a time, sadly. Also, XYZZYnews is
    # a special case.)
    RewriteRule ^/indexes/if-archiveXmagazinesXXYZZYnews.html /indexes/if-archive/magazines/XYZZYnews/ [R=301] [L]
    RewriteRule ^/indexes/if-archive.html /indexes/if-archive/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+).html /indexes/if-archive/$1/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/$6/ [R=301] [L]

    # When someone is redirected (by cloudflare) to here, serve an error
    # page. (Note that the contents of uk-block.html are ignored.)
    RewriteRule ^/misc/uk-block.html - [R=451,L]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName ifarchive.org
    ServerAlias www.ifarchive.org
    ServerAlias mirror.ifarchive.org
    ServerAlias origin.ifarchive.org
    ServerAlias ukrestrict.ifarchive.org
    ServerAlias bottle.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-ifarchive-access.log combined
    ErrorLog /var/ifarchive/logs/apache-ifarchive-error.log

    <Directory "/var/ifarchive/htdocs/">
       # List of IP addresses used by Cloudflare; updated Aug 2025
       # https://www.cloudflare.com/ips/ 
       Require ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
       Require ip 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
       Options +Indexes +FollowSymLinks +MultiViews
       DirectoryIndex index.html index.htm
       ReadmeName /misc/autoindex-footer.html
    </Directory>

    # Letsencrypt has to be able to check .well-known.
    <Directory "/var/ifarchive/htdocs/.well-known">
       Require all granted
    </Directory>

    # The Archive content directory (and subdirs) have custom auto-indexing.
    # Also needs Access-Control-Allow-Origin for archived files. This
    # allows sites like iplayif.com to fetch games with client-side code.
    <Directory "/var/ifarchive/htdocs/if-archive/">
        HeaderName Index
        ReadmeName /misc/autoindex-footer.html
        IndexOptions FancyIndexing HTMLTable SuppressDescription SuppressIcon IgnoreCase FoldersFirst
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    # The "Index" files are presumed to be UTF-8.
    <Files Index>
        ForceType text/plain;charset="UTF-8"
    </Files>

    # Our 451 "Unavailable For Legal Reasons" error page. The uk-block.html
    # page will redirect here.
    # This has Access-Control-Allow-Origin as well. This allows Parchment
    # (for example) to observe the error status in client-side code.
    ErrorDocument 451 /misc/451-error.html
    <Location /misc/451-error.html>
        Header set Link "<https://ifarchive.org>; rel=\"blocked-by\""
        Header set Access-Control-Allow-Origin "*"
    </Location>

    # The upload CGI script must be redirected to upload.ifarchive.org.
    RewriteEngine On
    RewriteRule ^/cgi-bin/(.*)$ https://upload.ifarchive.org/cgi-bin/$1 [R]
    
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004
    
    # Redirect the old X-ified index pages to the current ones.
    # (We have to do this one layer at a time, sadly. Also, XYZZYnews is
    # a special case.)
    RewriteRule ^/indexes/if-archiveXmagazinesXXYZZYnews.html /indexes/if-archive/magazines/XYZZYnews/ [R=301] [L]
    RewriteRule ^/indexes/if-archive.html /indexes/if-archive/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+).html /indexes/if-archive/$1/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/$6/ [R=301] [L]

    # When someone is redirected (by cloudflare) to here, serve an error
    # page. (Note that the contents of uk-block.html are ignored.)
    RewriteRule ^/misc/uk-block.html - [R=451,L]

</VirtualHost>

# The "core" subdomains. These are the web services which live on subdomains
# but are tightly integrated with the Archive.

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias upload.ifarchive.org

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-upload-access.log combined
    ErrorLog /var/ifarchive/logs/apache-upload-error.log
    ScriptAlias /cgi-bin/ /var/ifarchive/cgi-bin/

    <Directory "/var/ifarchive/htdocs/">
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://upload.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias upload.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-upload-access.log combined
    ErrorLog /var/ifarchive/logs/apache-upload-error.log
    ScriptAlias /cgi-bin/ /var/ifarchive/cgi-bin/
    WSGIScriptAlias /admin /var/ifarchive/wsgi-bin/admin.wsgi

    <Directory "/var/ifarchive/htdocs/">
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/cgi-bin/">
        Options +ExecCGI
        SetHandler cgi-script
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # Don't serve files (other than misc). Redirect back to the main site.
    RewriteEngine On
    RewriteRule ^/indexes/(.*)$ https://ifarchive.org/indexes/$1 [R]
    RewriteRule ^/if-archive/(.*)$ https://ifarchive.org/if-archive/$1 [R]
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias admin.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/admin/htdocs/
    CustomLog /var/ifarchive/logs/apache-admin-access.log combined
    ErrorLog /var/ifarchive/logs/apache-admin-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/admin/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://admin.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias admin.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/admin/htdocs/
    CustomLog /var/ifarchive/logs/apache-admin-access.log combined
    ErrorLog /var/ifarchive/logs/apache-admin-error.log
    WSGIScriptAlias /admin /var/ifarchive/wsgi-bin/admin.wsgi

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/admin/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # The front page is a stub, so we don't have to redirect that.

    RewriteEngine On
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias search.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/search/htdocs/
    CustomLog /var/ifarchive/logs/apache-search-access.log combined
    ErrorLog /var/ifarchive/logs/apache-search-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/search/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://search.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias search.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/search/htdocs/
    CustomLog /var/ifarchive/logs/apache-search-access.log combined
    ErrorLog /var/ifarchive/logs/apache-search-error.log
    WSGIScriptAlias /search /var/ifarchive/wsgi-bin/search.wsgi

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/search/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # Redirect the front page (only) to the search page.
    RewriteEngine On
    RewriteRule ^/$ /search [R]

</VirtualHost>


<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias interstitial.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/interstitial/htdocs/
    CustomLog /var/ifarchive/logs/apache-interstitial-access.log combined
    ErrorLog /var/ifarchive/logs/apache-interstitial-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/interstitial/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    # Redirect all to https.
    ###RewriteEngine On
    ###RewriteRule ^(.*)$ https://interstitial.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias interstitial.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/interstitial/htdocs/
    CustomLog /var/ifarchive/logs/apache-interstitial-access.log combined
    ErrorLog /var/ifarchive/logs/apache-interstitial-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/interstitial/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

</VirtualHost>
