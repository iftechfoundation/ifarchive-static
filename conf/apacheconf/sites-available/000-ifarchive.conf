# This file contains virtual host configuration for the main IF Archive.
# See also: 001-services.conf, 005-subdoms.conf,
# and ../conf-available/ifarchive.conf.

SSLSessionCache  shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)
SSLSessionCacheTimeout  300

# The virtualhost section below is repeated twice, for http (port 80)
# and https (port 443). The only difference is the SSL directives.
# This is because the root domain works equally well with http: and
# https: access.

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName ifarchive.org
    ServerAlias www.ifarchive.org
    ServerAlias mirror.ifarchive.org
    ServerAlias origin.ifarchive.org
    ServerAlias ukrestrict.ifarchive.org
    ServerAlias bottle.ifarchive.org

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-ifarchive-access.log combined
    ErrorLog /var/ifarchive/logs/apache-ifarchive-error.log

    <Directory "/var/ifarchive/htdocs/">
       # List of IP addresses used by Cloudflare; updated Aug 2025
       # https://www.cloudflare.com/ips/ 
       Require ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
       Require ip 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
       Options +Indexes +FollowSymLinks +MultiViews
       DirectoryIndex index.html index.htm
       ReadmeName /misc/autoindex-footer.html
    </Directory>

    # Letsencrypt has to be able to check .well-known.
    <Directory "/var/ifarchive/htdocs/.well-known">
       Require all granted
    </Directory>

    # The Archive content directory (and subdirs) have custom auto-indexing.
    # Also needs Access-Control-Allow-Origin for archived files. This
    # allows sites like iplayif.com to fetch games with client-side code.
    <Directory "/var/ifarchive/htdocs/if-archive/">
        HeaderName Index
        ReadmeName /misc/autoindex-footer.html
        IndexOptions FancyIndexing HTMLTable SuppressDescription SuppressIcon IgnoreCase FoldersFirst
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    # The "Index" files are presumed to be UTF-8.
    <Files Index>
        ForceType text/plain;charset="UTF-8"
    </Files>

    # Our 451 "Unavailable For Legal Reasons" error page. The uk-block.html
    # page will redirect here.
    # This has Access-Control-Allow-Origin as well. This allows Parchment
    # (for example) to observe the error status in client-side code.
    ErrorDocument 451 /misc/451-error.html
    <Location /misc/451-error.html>
        Header set Link "<https://ifarchive.org>; rel=\"blocked-by\""
        Header set Access-Control-Allow-Origin "*"
    </Location>

    # The upload CGI script must be redirected to upload.ifarchive.org.
    RewriteEngine On
    RewriteRule ^/cgi-bin/(.*)$ https://upload.ifarchive.org/cgi-bin/$1 [R]
    
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004
    
    # Redirect the old X-ified index pages to the current ones.
    # (We have to do this one layer at a time, sadly. Also, XYZZYnews is
    # a special case.)
    RewriteRule ^/indexes/if-archiveXmagazinesXXYZZYnews.html /indexes/if-archive/magazines/XYZZYnews/ [R=301] [L]
    RewriteRule ^/indexes/if-archive.html /indexes/if-archive/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+).html /indexes/if-archive/$1/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/$6/ [R=301] [L]

    # When someone is redirected (by cloudflare) to here, serve an error
    # page. (Note that the contents of uk-block.html are ignored.)
    RewriteRule ^/misc/uk-block.html - [R=451,L]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName ifarchive.org
    ServerAlias www.ifarchive.org
    ServerAlias mirror.ifarchive.org
    ServerAlias origin.ifarchive.org
    ServerAlias ukrestrict.ifarchive.org
    ServerAlias bottle.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-ifarchive-access.log combined
    ErrorLog /var/ifarchive/logs/apache-ifarchive-error.log

    <Directory "/var/ifarchive/htdocs/">
       # List of IP addresses used by Cloudflare; updated Aug 2025
       # https://www.cloudflare.com/ips/ 
       Require ip 173.245.48.0/20 103.21.244.0/22 103.22.200.0/22 103.31.4.0/22 141.101.64.0/18 108.162.192.0/18 190.93.240.0/20 188.114.96.0/20 197.234.240.0/22 198.41.128.0/17 162.158.0.0/15 104.16.0.0/13 104.24.0.0/14 172.64.0.0/13 131.0.72.0/22
       Require ip 2400:cb00::/32 2606:4700::/32 2803:f800::/32 2405:b500::/32 2405:8100::/32 2a06:98c0::/29 2c0f:f248::/32
       Options +Indexes +FollowSymLinks +MultiViews
       DirectoryIndex index.html index.htm
       ReadmeName /misc/autoindex-footer.html
    </Directory>

    # Letsencrypt has to be able to check .well-known.
    <Directory "/var/ifarchive/htdocs/.well-known">
       Require all granted
    </Directory>

    # The Archive content directory (and subdirs) have custom auto-indexing.
    # Also needs Access-Control-Allow-Origin for archived files. This
    # allows sites like iplayif.com to fetch games with client-side code.
    <Directory "/var/ifarchive/htdocs/if-archive/">
        HeaderName Index
        ReadmeName /misc/autoindex-footer.html
        IndexOptions FancyIndexing HTMLTable SuppressDescription SuppressIcon IgnoreCase FoldersFirst
        Header set Access-Control-Allow-Origin "*"
    </Directory>

    # The "Index" files are presumed to be UTF-8.
    <Files Index>
        ForceType text/plain;charset="UTF-8"
    </Files>

    # Our 451 "Unavailable For Legal Reasons" error page. The uk-block.html
    # page will redirect here.
    # This has Access-Control-Allow-Origin as well. This allows Parchment
    # (for example) to observe the error status in client-side code.
    ErrorDocument 451 /misc/451-error.html
    <Location /misc/451-error.html>
        Header set Link "<https://ifarchive.org>; rel=\"blocked-by\""
        Header set Access-Control-Allow-Origin "*"
    </Location>

    # The upload CGI script must be redirected to upload.ifarchive.org.
    RewriteEngine On
    RewriteRule ^/cgi-bin/(.*)$ https://upload.ifarchive.org/cgi-bin/$1 [R]
    
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004
    
    # Redirect the old X-ified index pages to the current ones.
    # (We have to do this one layer at a time, sadly. Also, XYZZYnews is
    # a special case.)
    RewriteRule ^/indexes/if-archiveXmagazinesXXYZZYnews.html /indexes/if-archive/magazines/XYZZYnews/ [R=301] [L]
    RewriteRule ^/indexes/if-archive.html /indexes/if-archive/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+).html /indexes/if-archive/$1/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/$6/ [R=301] [L]

    # When someone is redirected (by cloudflare) to here, serve an error
    # page. (Note that the contents of uk-block.html are ignored.)
    RewriteRule ^/misc/uk-block.html - [R=451,L]

</VirtualHost>

