# This file contains virtual host configuration specific to IF Archive.
# See also: ../conf-available/ifarchive.conf

SSLSessionCache		shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)
SSLSessionCacheTimeout  300

# Every virtualhost section below is repeated twice, for http (port 80)
# and https (port 443). The only difference is the SSL directives.

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName ifarchive.org
    ServerAlias www.ifarchive.org
    ServerAlias mirror.ifarchive.org
    ServerAlias origin.ifarchive.org
    ServerAlias bottle.ifarchive.org

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-ifarchive-access.log combined
    ErrorLog /var/ifarchive/logs/apache-ifarchive-error.log

    <Directory "/var/ifarchive/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
       DirectoryIndex index.html index.htm
       ReadmeName /misc/autoindex-footer.html
    </Directory>

    # The Archive content directory (and subdirs) have custom auto-indexing.
    <Directory "/var/ifarchive/htdocs/if-archive/">
        HeaderName Index
        ReadmeName /misc/autoindex-footer.html
        IndexOptions FancyIndexing HTMLTable SuppressDescription SuppressIcon IgnoreCase FoldersFirst
	Header set Access-Control-Allow-Origin "*"
    </Directory>

    # The "Index" files are presumed to be UTF-8.
    <Files Index>
        ForceType text/plain;charset="UTF-8"
    </Files>

    # The upload CGI script must be redirected to upload.ifarchive.org.
    RewriteEngine On
    RewriteRule ^/cgi-bin/(.*)$ https://upload.ifarchive.org/cgi-bin/$1 [R]
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004
    # Redirect the old X-ified index pages to the current ones.
    # (We have to do this one layer at a time, sadly. Also, XYZZYnews is
    # a special case.)
    RewriteRule ^/indexes/if-archiveXmagazinesXXYZZYnews.html /indexes/if-archive/magazines/XYZZYnews/ [R=301] [L]
    RewriteRule ^/indexes/if-archive.html /indexes/if-archive/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+).html /indexes/if-archive/$1/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/$6/ [R=301] [L]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName ifarchive.org
    ServerAlias www.ifarchive.org
    ServerAlias mirror.ifarchive.org
    ServerAlias origin.ifarchive.org
    ServerAlias bottle.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-ifarchive-access.log combined
    ErrorLog /var/ifarchive/logs/apache-ifarchive-error.log

    <Directory "/var/ifarchive/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
       DirectoryIndex index.html index.htm
       ReadmeName /misc/autoindex-footer.html
    </Directory>

    # The Archive content directory (and subdirs) have custom auto-indexing.
    <Directory "/var/ifarchive/htdocs/if-archive/">
        HeaderName Index
        ReadmeName /misc/autoindex-footer.html
        IndexOptions FancyIndexing HTMLTable SuppressDescription SuppressIcon IgnoreCase FoldersFirst
	Header set Access-Control-Allow-Origin "*"
    </Directory>

    # The "Index" files are presumed to be UTF-8.
    <Files Index>
        ForceType text/plain;charset="UTF-8"
    </Files>

    # The upload CGI script must be redirected to upload.ifarchive.org.
    RewriteEngine On
    RewriteRule ^/cgi-bin/(.*)$ https://upload.ifarchive.org/cgi-bin/$1 [R]
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004
    # Redirect the old X-ified index pages to the current ones.
    # (We have to do this one layer at a time, sadly. Also, XYZZYnews is
    # a special case.)
    RewriteRule ^/indexes/if-archiveXmagazinesXXYZZYnews.html /indexes/if-archive/magazines/XYZZYnews/ [R=301] [L]
    RewriteRule ^/indexes/if-archive.html /indexes/if-archive/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+).html /indexes/if-archive/$1/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/ [R=301] [L]
    RewriteRule ^/indexes/if-archiveX([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+)X([^X]+).html /indexes/if-archive/$1/$2/$3/$4/$5/$6/ [R=301] [L]

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias upload.ifarchive.org

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-upload-access.log combined
    ErrorLog /var/ifarchive/logs/apache-upload-error.log
    ScriptAlias /cgi-bin/ /var/ifarchive/cgi-bin/

    <Directory "/var/ifarchive/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://upload.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias upload.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-upload-access.log combined
    ErrorLog /var/ifarchive/logs/apache-upload-error.log
    ScriptAlias /cgi-bin/ /var/ifarchive/cgi-bin/
    WSGIScriptAlias /admin /var/ifarchive/wsgi-bin/admin.wsgi

    <Directory "/var/ifarchive/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/cgi-bin/">
        Options +ExecCGI
        SetHandler cgi-script
        Order allow,deny
        Allow from all
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # Don't serve files (other than misc). Redirect back to the main site.
    RewriteEngine On
    RewriteRule ^/indexes/(.*)$ https://ifarchive.org/indexes/$1 [R]
    RewriteRule ^/if-archive/(.*)$ https://ifarchive.org/if-archive/$1 [R]
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004

</VirtualHost>

# This can't be in a VirtualHost section
WSGIPythonPath /var/ifarchive/wsgi-bin

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName babel.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/babel/htdocs
    CustomLog /var/ifarchive/logs/apache-babel-access.log combined
    ErrorLog /var/ifarchive/logs/apache-babel-error.log

    <Directory "/var/ifarchive/subdom/babel/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName babel.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/babel/htdocs
    CustomLog /var/ifarchive/logs/apache-babel-access.log combined
    ErrorLog /var/ifarchive/logs/apache-babel-error.log

    <Directory "/var/ifarchive/subdom/babel/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName inform-fiction.ifarchive.org
    ServerAlias inform-fiction.org
    ServerAlias www.inform-fiction.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/inform-fiction/htdocs
    CustomLog /var/ifarchive/logs/apache-inform-fiction-access.log combined
    ErrorLog /var/ifarchive/logs/apache-inform-fiction-error.log

    <Location "/">
       Options +Includes
       AddOutputFilter INCLUDES .html

       AddType application/x-zmachine z1 z2 z3 z4 z5 z6 z7 z8
       AddType application/x-blorb blb BLB blorb BLORB
       AddType application/x-blorb;profile="zcode" zlb zblorb
       AddType application/x-blorb;profile="glulx" glb gblorb
       AddHandler default-handler .pl
       AddType text/plain .pl

       RewriteEngine On
       RewriteBase /
       RewriteRule inform6.html /index.html [R=permanent,L]
    
       Redirect /I7Downloads/Documents http://inform7.com/learn/documents
       Redirect /I7Downloads/Examples/alabaster http://emshort.home.mindspring.com/Alabaster
       Redirect /I7Downloads/Examples http://inform7.com/learn/eg
       Redirect /I7Downloads/Extensions http://inform7.com/extensions
       Redirect /I7Downloads/Anthology http://inform7.com/if/anthology
       Redirect /I7Downloads/ReleaseNotes.txt http://inform7.com/learn/logs/6G60.txt
    </Location>
					
    <Directory "/var/ifarchive/subdom/inform-fiction/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

    # Text and I6 source files are assumed to be Latin-1.
    <Files *.txt>
       ForceType text/plain;charset="iso-8859-1"
    </Files>
    <Files *.inf>
       ForceType text/plain;charset="iso-8859-1"
    </Files>
    
    # Allow HTML files to set their own charset via meta tags.
    <Files *.html>
       ForceType text/html
    </Files>
    <Files *.htm>
       ForceType text/html
    </Files>

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName inform-fiction.ifarchive.org
    ServerAlias inform-fiction.org
    ServerAlias www.inform-fiction.org

    DocumentRoot /var/ifarchive/subdom/inform-fiction/htdocs
    CustomLog /var/ifarchive/logs/apache-inform-fiction-access.log combined
    ErrorLog /var/ifarchive/logs/apache-inform-fiction-error.log

    <Location "/">
       Options +Includes
       AddOutputFilter INCLUDES .html

       AddType application/x-zmachine z1 z2 z3 z4 z5 z6 z7 z8
       AddType application/x-blorb blb BLB blorb BLORB
       AddType application/x-blorb;profile="zcode" zlb zblorb
       AddType application/x-blorb;profile="glulx" glb gblorb
       AddHandler default-handler .pl
       AddType text/plain .pl

       RewriteEngine On
       RewriteBase /
       RewriteRule inform6.html /index.html [R=permanent,L]
    
       Redirect /I7Downloads/Documents http://inform7.com/learn/documents
       Redirect /I7Downloads/Examples/alabaster http://emshort.home.mindspring.com/Alabaster
       Redirect /I7Downloads/Examples http://inform7.com/learn/eg
       Redirect /I7Downloads/Extensions http://inform7.com/extensions
       Redirect /I7Downloads/Anthology http://inform7.com/if/anthology
       Redirect /I7Downloads/ReleaseNotes.txt http://inform7.com/learn/logs/6G60.txt
    </Location>
					
    <Directory "/var/ifarchive/subdom/inform-fiction/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

    # Text and I6 source files are assumed to be Latin-1.
    <Files *.txt>
       ForceType text/plain;charset="iso-8859-1"
    </Files>
    <Files *.inf>
       ForceType text/plain;charset="iso-8859-1"
    </Files>
    
    # Allow HTML files to set their own charset via meta tags.
    <Files *.html>
       ForceType text/html
    </Files>
    <Files *.htm>
       ForceType text/html
    </Files>

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName infodoc.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/infodoc/htdocs
    CustomLog /var/ifarchive/logs/apache-infodoc-access.log combined
    ErrorLog /var/ifarchive/logs/apache-infodoc-error.log

    <Directory "/var/ifarchive/subdom/infodoc/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

    # We don't serve files; we redirect all comers to the real
    # InfoDoc archive on plover.net.
    # (Okay, we do serve files from Let's Encrypt's special ".well-known"
    # driectory. But that's it.)
    RewriteEngine On
    RewriteCond expr "! %{REQUEST_URI} -strmatch '/.well-known/*'"
    RewriteRule ^(.*)$ http://infodoc.plover.net/ [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName infodoc.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/infodoc/htdocs
    CustomLog /var/ifarchive/logs/apache-infodoc-access.log combined
    ErrorLog /var/ifarchive/logs/apache-infodoc-error.log

    <Directory "/var/ifarchive/subdom/infodoc/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

    # We don't serve files; we redirect all comers to the real
    # InfoDoc archive on plover.net.
    # (Okay, we do serve files from Let's Encrypt's special ".well-known"
    # driectory. But that's it.)
    RewriteEngine On
    RewriteCond expr "! %{REQUEST_URI} -strmatch '/.well-known/*'"
    RewriteRule ^(.*)$ http://infodoc.plover.net/ [R]

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName rsync.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/rsync/htdocs
    CustomLog /var/ifarchive/logs/apache-misc-access.log combined
    ErrorLog /var/ifarchive/logs/apache-misc-error.log

    <Directory "/var/ifarchive/subdom/rsync/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName rsync.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/rsync/htdocs
    CustomLog /var/ifarchive/logs/apache-misc-access.log combined
    ErrorLog /var/ifarchive/logs/apache-misc-error.log

    <Directory "/var/ifarchive/subdom/rsync/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
       Options +Indexes +FollowSymLinks +MultiViews
    </Directory>

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerName unassigned.ifarchive.org
    ServerAlias *.ifarchive.org
    ServerAlias *

    DocumentRoot /var/ifarchive/subdom/unassigned/htdocs
    CustomLog /var/ifarchive/logs/apache-unassigned-access.log combined
    ErrorLog /var/ifarchive/logs/apache-unassigned-error.log

    <Directory "/var/ifarchive/subdom/unassigned/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
    </Directory>

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerName unassigned.ifarchive.org
    ServerAlias *.ifarchive.org
    ServerAlias *

    # The SSL cert won't match "unassigned" or wild subdomains, but we
    # follow the pattern above.
    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/unassigned/htdocs
    CustomLog /var/ifarchive/logs/apache-unassigned-access.log combined
    ErrorLog /var/ifarchive/logs/apache-unassigned-error.log

    <Directory "/var/ifarchive/subdom/unassigned/htdocs/">
       Order allow,deny
       Allow from all
       Require all granted
    </Directory>

</VirtualHost>
