# The "core" subdomains. These are the web services which live on subdomains
# but are tightly integrated with the Archive. Most of these subdomains
# have their own htdocs tree in /var/ifarchive/subdom.

# Every virtualhost section below is repeated twice, for http (port 80)
# and https (port 443). The only difference is the SSL directives.
# Note that the SSL cert for these subdomains is shared with the root
# domain; some SSL parameters are in 000-ifarchive.conf.

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias upload.ifarchive.org

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-upload-access.log combined
    ErrorLog /var/ifarchive/logs/apache-upload-error.log
    ScriptAlias /cgi-bin/ /var/ifarchive/cgi-bin/

    <Directory "/var/ifarchive/htdocs/">
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://upload.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias upload.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/htdocs/
    CustomLog /var/ifarchive/logs/apache-upload-access.log combined
    ErrorLog /var/ifarchive/logs/apache-upload-error.log
    ScriptAlias /cgi-bin/ /var/ifarchive/cgi-bin/
    WSGIScriptAlias /admin /var/ifarchive/wsgi-bin/admin.wsgi

    <Directory "/var/ifarchive/htdocs/">
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/cgi-bin/">
        Options +ExecCGI
        SetHandler cgi-script
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # Don't serve files (other than misc). Redirect back to the main site.
    RewriteEngine On
    RewriteRule ^/indexes/(.*)$ https://ifarchive.org/indexes/$1 [R]
    RewriteRule ^/if-archive/(.*)$ https://ifarchive.org/if-archive/$1 [R]
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias admin.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/admin/htdocs/
    CustomLog /var/ifarchive/logs/apache-admin-access.log combined
    ErrorLog /var/ifarchive/logs/apache-admin-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/admin/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://admin.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias admin.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/admin/htdocs/
    CustomLog /var/ifarchive/logs/apache-admin-access.log combined
    ErrorLog /var/ifarchive/logs/apache-admin-error.log
    WSGIScriptAlias /admin /var/ifarchive/wsgi-bin/admin.wsgi

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/admin/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # The front page is a stub, so we don't have to redirect that.

    RewriteEngine On
    # And /misc/uploader-docs.html redirects to a forum post.
    RewriteRule ^/misc/uploader-docs.html https://intfiction.org/t/if-archive-uploading-info/66004

</VirtualHost>

<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias search.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/search/htdocs/
    CustomLog /var/ifarchive/logs/apache-search-access.log combined
    ErrorLog /var/ifarchive/logs/apache-search-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/search/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    # Redirect all to https.
    RewriteEngine On
    RewriteRule ^(.*)$ https://search.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias search.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/search/htdocs/
    CustomLog /var/ifarchive/logs/apache-search-access.log combined
    ErrorLog /var/ifarchive/logs/apache-search-error.log
    WSGIScriptAlias /search /var/ifarchive/wsgi-bin/search.wsgi

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/search/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    <Directory "/var/ifarchive/wsgi-bin/">
        Require all granted
        SetEnv LANG en_US.UTF-8
    </Directory>

    # Redirect the front page (only) to the search page.
    RewriteEngine On
    RewriteRule ^/$ /search [R]

</VirtualHost>


<VirtualHost 45.79.155.122:80 2600:3c03::f03c:91ff:fe3e:fc79:80>
    ServerAlias interstitial.ifarchive.org

    DocumentRoot /var/ifarchive/subdom/interstitial/htdocs/
    CustomLog /var/ifarchive/logs/apache-interstitial-access.log combined
    ErrorLog /var/ifarchive/logs/apache-interstitial-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/interstitial/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

    # Redirect all to https.
    ###RewriteEngine On
    ###RewriteRule ^(.*)$ https://interstitial.ifarchive.org$1 [R]

</VirtualHost>

<VirtualHost 45.79.155.122:443 2600:3c03::f03c:91ff:fe3e:fc79:443>
    ServerAlias interstitial.ifarchive.org

    SSLEngine On
    SSLCertificateKeyFile /etc/letsencrypt/live/ifarchive.org/privkey.pem
    SSLCertificateFile /etc/letsencrypt/live/ifarchive.org/cert.pem
    SSLCertificateChainFile /etc/letsencrypt/live/ifarchive.org/fullchain.pem

    DocumentRoot /var/ifarchive/subdom/interstitial/htdocs/
    CustomLog /var/ifarchive/logs/apache-interstitial-access.log combined
    ErrorLog /var/ifarchive/logs/apache-interstitial-error.log

    Alias "/misc" "/var/ifarchive/htdocs/misc"

    <Directory "/var/ifarchive/subdom/interstitial/htdocs/">
       Require all granted
    </Directory>
    <Directory "/var/ifarchive/htdocs/misc/">
       Require all granted
    </Directory>

</VirtualHost>
